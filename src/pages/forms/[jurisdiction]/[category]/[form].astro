---
// Individual form page - displays linked FormPage + selected FormFile
import Layout from "../../../../layouts/Layout.astro";
import Breadcrumbs from "../../../../components/Breadcrumbs.astro";
import QueryBox from "../../../../components/QueryBox.astro";
import { graphqlRequest } from "../../../../lib/wpGraphql";

// Enable server-side rendering for dynamic routes
export const prerender = false;

// GraphQL query for a specific form-file and its linked form-page
const FILE_QUERY = `
query FormFilePage($fileSlug: ID!) {
  formFile(id: $fileSlug, idType: SLUG) {
    title
    slug
    featuredImage {
      node {
        sourceUrl
      }
    }
    formPageJurisdictions {
      nodes {
        name
        slug
      }
    }
    formPageCategories {
      nodes {
        name
        slug
      }
    }
    formFileData {
      pdfFile {
        node {
          sourceUrl
          mediaItemUrl
        }
      }
      formPageLinkage(first: 1) {
        nodes {
          ... on FormPage {
            title
            slug
            formPageData {
              shortName
              formName
              shortDescription
              longDescription
              generalInstructions
              formUrl
              steps {
                step
              }
              formFiles(first: 50) {
                nodes {
                  ... on FormFile {
                    id
                    title
                    slug
                  }
                }
              }
            }
            seo {
              title
              metaDesc
              opengraphTitle
              opengraphDescription
              opengraphImage {
                sourceUrl
              }
            }
          }
        }
      }
    }
  }
}
`;

// Fallback query to resolve a form-file slug when none provided
const FALLBACK_QUERY = `
query FormFileFallback($categorySlug: ID!, $jurisdictionSlug: ID!, $fallbackSize: Int!) {
  formFiles(where: { offsetPagination: { offset: 0, size: $fallbackSize }, formPageCategory: [$categorySlug], formPageJurisdiction: [$jurisdictionSlug] }) {
    nodes {
      slug
      formFileData {
        formPageLinkage(first: 1) {
          nodes {
            ... on FormPage {
              slug
              formPageData {
                shortName
              }
            }
          }
        }
      }
    }
  }
}
`;

type FormFileResponse = {
  formFile: {
    title: string | null;
    slug: string;
    featuredImage: {
      node: {
        sourceUrl: string;
      };
    } | null;
    formPageJurisdictions: {
      nodes: Array<{
        name: string;
        slug: string;
      }>;
    };
    formPageCategories: {
      nodes: Array<{
        name: string;
        slug: string;
      }>;
    };
    formFileData: {
      pdfFile: {
        node: {
          sourceUrl: string;
          mediaItemUrl: string;
        };
      } | null;
      formPageLinkage: {
        nodes: Array<{
          title: string | null;
          slug: string;
          formPageData: {
            shortName: string | null;
            formName: string | null;
            shortDescription: string | null;
            longDescription: string | null;
            generalInstructions: string | null;
            formUrl: string | null;
            steps: Array<{
              step: string | null;
            }> | null;
            formFiles: {
              nodes: Array<{
                title: string | null;
                slug: string;
              }>;
            } | null;
          } | null;
          seo: {
            title: string | null;
            metaDesc: string | null;
            opengraphTitle: string | null;
            opengraphDescription: string | null;
            opengraphImage: {
              sourceUrl: string;
            } | null;
          } | null;
        }>;
      } | null;
    } | null;
  } | null;
};

type FormFileFallbackResponse = {
  formFiles: {
    nodes: Array<{
      slug: string;
      formFileData: {
        formPageLinkage: {
          nodes: Array<{
            slug: string;
            formPageData: {
              shortName: string | null;
            } | null;
          }>;
        } | null;
      } | null;
    }>;
  };
};

// Get params from URL
const { jurisdiction, category, form } = Astro.params;

if (!jurisdiction || !category || !form) {
  return Astro.redirect("/forms");
}

// Get form-file slug query param if provided
const url = new URL(Astro.request.url);
const selectedFileSlug = url.searchParams.get("file");

if (!selectedFileSlug) {
  const fallbackData = await graphqlRequest<FormFileFallbackResponse>(
    FALLBACK_QUERY,
    {
      categorySlug: category,
      jurisdictionSlug: jurisdiction,
      fallbackSize: 50,
    },
  );

  const normalizedFormParam = form.toLowerCase().replace(/[^a-z0-9]/g, "");
  const fallbackFile = fallbackData.formFiles.nodes.find((file) => {
    const linkedPage = file.formFileData?.formPageLinkage?.nodes?.[0];
    const shortName = linkedPage?.formPageData?.shortName;
    if (!shortName) {
      return false;
    }
    const normalizedShortName = shortName
      .toLowerCase()
      .replace(/[^a-z0-9]/g, "");
    return normalizedShortName === normalizedFormParam;
  });
  const fallbackLinkedPage =
    fallbackFile?.formFileData?.formPageLinkage?.nodes?.[0];
  const fallbackFileSlug = fallbackFile?.slug;
  const fallbackFormSlug =
    fallbackLinkedPage?.formPageData?.shortName ||
    fallbackLinkedPage?.slug ||
    form;

  if (fallbackFileSlug) {
    return Astro.redirect(
      `/forms/${jurisdiction}/${category}/${fallbackFormSlug}?file=${encodeURIComponent(fallbackFileSlug)}`,
    );
  }

  return Astro.redirect(`/forms/${jurisdiction}/${category}`);
}

const fileData = await graphqlRequest<FormFileResponse>(FILE_QUERY, {
  fileSlug: selectedFileSlug,
});

const formFile = fileData.formFile;
const formPage = formFile?.formFileData?.formPageLinkage?.nodes?.[0];

if (!formFile || !formPage) {
  return Astro.redirect(`/forms/${jurisdiction}/${category}`);
}

const acf = formPage.formPageData;
const availableFiles = acf?.formFiles?.nodes ?? [];

const jurisdictionTerm =
  formFile.formPageJurisdictions.nodes.find((j) => j.slug === jurisdiction) ||
  formFile.formPageJurisdictions.nodes[0];
const categoryTerm =
  formFile.formPageCategories.nodes.find((c) => c.slug === category) ||
  formFile.formPageCategories.nodes[0];

const normalizedShortName = (acf?.shortName || formPage.slug || "")
  .toLowerCase()
  .replace(/[^a-z0-9]/g, "");
const normalizedFormParam = form.toLowerCase().replace(/[^a-z0-9]/g, "");
const isFormMatch =
  normalizedShortName !== "" && normalizedShortName === normalizedFormParam;

if (
  !jurisdictionTerm ||
  !categoryTerm ||
  !isFormMatch ||
  jurisdictionTerm.slug !== jurisdiction ||
  categoryTerm.slug !== category
) {
  const canonicalFormSlug = acf?.shortName || formPage.slug || form;
  return Astro.redirect(
    `/forms/${jurisdictionTerm?.slug || jurisdiction}/${categoryTerm?.slug || category}/${canonicalFormSlug}?file=${encodeURIComponent(formFile.slug)}`,
  );
}

const activeFile = formFile;

const jurisdictionLabel = jurisdictionTerm?.name || jurisdiction;
const categoryLabel = categoryTerm?.name || category;
const formLabel = acf?.shortName || formPage.title || form;
const formSlug = acf?.shortName || formPage.slug || form;

const breadcrumbs = [
  { label: "Home", to: "/" },
  { label: "Forms", to: "/forms" },
  { label: jurisdictionLabel, to: `/forms/${jurisdiction}` },
  {
    label: categoryLabel,
    to: `/forms/${jurisdiction}/${category}`,
  },
  { label: formLabel },
];

const seo = formPage.seo;
const pageTitle = seo?.title || formPage.title || formLabel;
const pageDescription =
  seo?.metaDesc || acf?.shortDescription || `Form page for ${formLabel}`;
const ogTitle = seo?.opengraphTitle ?? undefined;
const ogDescription = seo?.opengraphDescription ?? undefined;
const ogImage = seo?.opengraphImage?.sourceUrl;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  ogTitle={ogTitle}
  ogDescription={ogDescription}
  ogImage={ogImage}
>
  <Breadcrumbs items={breadcrumbs} />

  <article class="section-card">
    <h1 class="section-title">{acf?.shortName || formPage.title || form}</h1>
    {
      acf?.formName && acf.formName !== acf.shortName && (
        <p style="font-size: 18px; color: #6b7280; margin-bottom: 16px;">
          {acf.formName}
        </p>
      )
    }

    {/* Taxonomies */}
    <div class="tag-list" style="margin-bottom: 16px;">
      <a href={`/forms/${jurisdictionTerm?.slug || jurisdiction}`} class="pill">
        üìç {jurisdictionLabel}
      </a>
      {
        categoryTerm && (
          <a href={`/forms/${jurisdiction}/${categoryTerm.slug}`} class="pill">
            üìÇ {categoryLabel}
          </a>
        )
      }
    </div>

    {/* PDF Versions/Years */}
    {
      availableFiles.length > 1 && (
        <div class="form-detail">
          <h2>Available Versions</h2>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            {availableFiles.map((file, index) => {
              const isActive = file.slug === activeFile.slug;
              const fileUrl = `/forms/${jurisdiction}/${category}/${formSlug}?file=${encodeURIComponent(file.slug)}`;

              return (
                <a
                  href={fileUrl}
                  class={`pill ${isActive ? "pill-active" : "pill-inactive"}`}
                  style={isActive ? "background: #2563eb; color: white;" : ""}
                >
                  {file.title || `Version ${index + 1}`}
                </a>
              );
            })}
          </div>
        </div>
      )
    }

    {/* ACF: Short Name */}
    {
      acf?.shortName && (
        <div class="form-detail">
          <h2>Short Name</h2>
          <p>{acf.shortName}</p>
        </div>
      )
    }

    {/* ACF: Form Name */}
    {
      acf?.formName && (
        <div class="form-detail">
          <h2>Form Name</h2>
          <p>{acf.formName}</p>
        </div>
      )
    }

    {/* ACF: Short Description */}
    {
      acf?.shortDescription && (
        <div class="form-detail">
          <h2>Short Description</h2>
          <p class="text-block">{acf.shortDescription}</p>
        </div>
      )
    }

    {/* ACF: Long Description */}
    {
      acf?.longDescription && (
        <div class="form-detail">
          <h2>Long Description</h2>
          <p class="text-block">{acf.longDescription}</p>
        </div>
      )
    }

    {/* ACF: General Instructions */}
    {
      acf?.generalInstructions && (
        <div class="form-detail">
          <h2>General Instructions</h2>
          <p class="text-block">{acf.generalInstructions}</p>
        </div>
      )
    }

    {/* ACF: Steps (Repeater) */}
    {
      acf?.steps && acf.steps.length > 0 && (
        <div class="form-detail">
          <h2>Steps</h2>
          <ol class="steps-list">
            {acf.steps.map(
              (stepItem) => stepItem.step && <li>{stepItem.step}</li>,
            )}
          </ol>
        </div>
      )
    }

    {/* ACF: Form URL */}
    {
      acf?.formUrl && (
        <div class="form-detail">
          <h2>Form URL</h2>
          <a href={acf.formUrl} target="_blank" rel="noopener noreferrer">
            {acf.formUrl}
          </a>
        </div>
      )
    }

    {/* ACF: Form PDF Download */}
    {
      activeFile && (
        <div class="form-detail">
          <h2>Download Form</h2>
          <div class="pdf-item" style="background: #f9fafb;">
            <div style="display: flex; gap: 16px; align-items: flex-start;">
              {activeFile.featuredImage?.node && (
                <img
                  src={activeFile.featuredImage.node.sourceUrl}
                  alt={activeFile.title || "Form thumbnail"}
                  style="max-width: 200px; border-radius: 8px; flex-shrink: 0; border: 1px solid #e5e7eb;"
                />
              )}

              <div style="flex: 1;">
                {activeFile.title && (
                  <h3 style="margin-top: 0;">{activeFile.title}</h3>
                )}
                {activeFile.formFileData?.pdfFile?.node && (
                  <a
                    href={
                      activeFile.formFileData.pdfFile.node.mediaItemUrl ||
                      activeFile.formFileData.pdfFile.node.sourceUrl
                    }
                    target="_blank"
                    rel="noopener noreferrer"
                    style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: #2563eb; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; margin-top: 12px;"
                  >
                    üìÑ Download PDF
                  </a>
                )}
              </div>
            </div>
          </div>
        </div>
      )
    }
  </article>

  <QueryBox
    query={FILE_QUERY}
    variables={{ fileSlug: selectedFileSlug }}
  />
</Layout>
