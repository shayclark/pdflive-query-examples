---
// Jurisdiction page - shows categories for a specific jurisdiction
import Layout from '../../../layouts/Layout.astro'
import Breadcrumbs from '../../../components/Breadcrumbs.astro'
import QueryBox from '../../../components/QueryBox.astro'
import Pagination from '../../../components/Pagination.astro'
import { graphqlRequest } from '../../../lib/wpGraphql'

// Enable server-side rendering for dynamic routes
export const prerender = false

// Get page number from URL
const url = new URL(Astro.request.url)
const currentPage = parseInt(url.searchParams.get('page') || '1', 10)
const perPage = 20

// GraphQL query
const QUERY = `
query JurisdictionPage($slug: ID!) {
  formPageJurisdiction(id: $slug, idType: SLUG) {
    id
    name
    slug
    count
    seo {
      title
      metaDesc
      opengraphTitle
      opengraphDescription
      opengraphImage {
        sourceUrl
      }
    }
    formPages(first: 200) {
      nodes {
        id
        title
        slug
        formPageJurisdictions {
          nodes {
            slug
          }
        }
        formPageCategories {
          nodes {
            slug
          }
        }
        formPageData {
          shortName
          shortDescription
          formPdfs {
            formLabel
            formThumbnail {
              node {
                sourceUrl
                mediaItemUrl
              }
            }
          }
        }
      }
    }
  }
  formPageCategories(first: 200) {
    nodes {
      id
      name
      slug
      count
    }
  }
}
`

type JurisdictionPageResponse = {
  formPageJurisdiction: {
    id: string
    name: string
    slug: string
    count: number | null
    seo: {
      title: string | null
      metaDesc: string | null
      opengraphTitle: string | null
      opengraphDescription: string | null
      opengraphImage: {
        sourceUrl: string
      } | null
    } | null
    formPages: {
      nodes: Array<{
        id: string
        title: string | null
        slug: string
        formPageJurisdictions: {
          nodes: Array<{ slug: string }>
        }
        formPageCategories: {
          nodes: Array<{ slug: string }>
        }
        formPageData: {
          shortName: string | null
          shortDescription: string | null
          formPdfs: Array<{
            formLabel: string | null
            formThumbnail: {
              node: {
                sourceUrl: string
                mediaItemUrl: string
              }
            } | null
          }> | null
        } | null
      }>
    }
  } | null
  formPageCategories: {
    nodes: Array<{
      id: string
      name: string
      slug: string
      count: number | null
    }>
  }
}

// Get jurisdiction slug from URL
const { jurisdiction } = Astro.params

if (!jurisdiction) {
  return Astro.redirect('/forms')
}

// Fetch data
const data = await graphqlRequest<JurisdictionPageResponse>(QUERY, { slug: jurisdiction })

if (!data.formPageJurisdiction) {
  return Astro.redirect('/forms')
}

const jurisdictionData = data.formPageJurisdiction

// Get forms directly from jurisdiction connection (already filtered)
const filteredForms = jurisdictionData.formPages.nodes

// Now count forms per category (prefiltered by jurisdiction)
const categoryCounts = new Map<string, number>()
filteredForms.forEach(form => {
  form.formPageCategories.nodes.forEach(cat => {
    categoryCounts.set(cat.slug, (categoryCounts.get(cat.slug) || 0) + 1)
  })
})

// Filter categories to only show those with forms in this jurisdiction
const allCategories = data.formPageCategories.nodes
  .filter(c => categoryCounts.has(c.slug) && categoryCounts.get(c.slug)! > 0)
  .map(c => ({
    ...c,
    count: categoryCounts.get(c.slug) || 0
  }))

const breadcrumbs = [
  { label: 'Home', to: '/' },
  { label: 'Forms', to: '/forms' },
  { label: jurisdictionData.name }
]

const seo = jurisdictionData.seo
const pageTitle = seo?.title || `${jurisdictionData.name} Forms`
const pageDescription = seo?.metaDesc || `Browse form pages for ${jurisdictionData.name}.`
const ogImage = seo?.opengraphImage?.sourceUrl
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  ogTitle={seo?.opengraphTitle}
  ogDescription={seo?.opengraphDescription}
  ogImage={ogImage}
>
  <Breadcrumbs items={breadcrumbs} />

  <section class="section-card">
    <h1 class="section-title">{jurisdictionData.name} Forms</h1>
    <p class="muted">Browse by category.</p>
    <ul class="list">
      {allCategories.map(category => (
        <li class="list-item">
          <a href={`/forms/${jurisdiction}/${category.slug}`}>
            {category.name}
          </a>
          <span class="pill">{category.count ?? 0} forms</span>
        </li>
      ))}
    </ul>
  </section>

  {(() => {
    // Flatten all PDFs from all forms into individual cards
    const allPdfs = filteredForms.flatMap(form => {
      const acf = form.formPageData
      const pdfs = acf?.formPdfs || []
      const category = form.formPageCategories.nodes[0]
      
      // If no PDFs, create a single entry for the form itself
      if (pdfs.length === 0) {
        return [{
          form,
          pdf: null,
          category,
          thumbnail: '/favicon.svg',
          title: acf?.shortName || form.title || form.slug,
          description: acf?.shortDescription
        }]
      }
      
      // Create an entry for each PDF
      return pdfs.map(pdf => ({
        form,
        pdf,
        category,
        thumbnail: pdf.formThumbnail?.node?.sourceUrl || '/favicon.svg',
        title: pdf.formLabel || acf?.shortName || form.title || form.slug,
        description: acf?.shortDescription
      }))
    })
    
    // Pagination
    const totalPdfs = allPdfs.length
    const totalPages = Math.ceil(totalPdfs / perPage)
    const startIndex = (currentPage - 1) * perPage
    const endIndex = startIndex + perPage
    const paginatedPdfs = allPdfs.slice(startIndex, endIndex)
    
    return allPdfs.length > 0 && (
      <section class="section-card">
        <h2 class="section-title">All PDFs in {jurisdictionData.name}</h2>
        <p class="muted">
          {totalPdfs} PDF{totalPdfs !== 1 ? 's' : ''} available
          {totalPages > 1 && ` Â· Page ${currentPage} of ${totalPages}`}
        </p>
        <div class="grid form-grid">
          {paginatedPdfs.map((item, index) => {
            const { form, pdf, category, thumbnail, title, description } = item
            const shortName = form.formPageData?.shortName || form.slug
            
            // Build URL using shortName with form-label query param if this is a specific PDF
            let formUrl = `/forms/${jurisdiction}/${category?.slug || 'uncategorized'}/${shortName}`
            if (pdf?.formLabel) {
              formUrl += `?form-label=${encodeURIComponent(pdf.formLabel)}`
            }
            
            return (
              <a href={formUrl} class="form-card" key={`pdf-${index}`}>
                <div class="form-card-image">
                  <img src={thumbnail} alt={title} loading="lazy" />
                </div>
                <div class="form-card-content">
                  <h3>{title}</h3>
                  {description && (
                    <p class="muted">{description.substring(0, 100)}{description.length > 100 ? '...' : ''}</p>
                  )}
                  {category && (
                    <span class="pill" style="margin-top: 8px;">
                      {category.name}
                    </span>
                  )}
                </div>
              </a>
            )
          })}
        </div>
        
        {totalPages > 1 && (
          <Pagination 
            currentPage={currentPage} 
            totalPages={totalPages} 
            baseUrl={`/forms/${jurisdiction}`} 
          />
        )}
      </section>
    )
  })()}

  <QueryBox query={QUERY} />
</Layout>
