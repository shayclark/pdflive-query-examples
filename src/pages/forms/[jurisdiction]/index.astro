---
// Jurisdiction page - shows categories for a specific jurisdiction
import Layout from "../../../layouts/Layout.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";
import QueryBox from "../../../components/QueryBox.astro";
import Pagination from "../../../components/Pagination.astro";
import { graphqlRequest } from "../../../lib/wpGraphql";

// Enable server-side rendering for dynamic routes
export const prerender = false;

// Get page number from URL
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get("page") || "1", 10);
const perPage = 20;

// GraphQL query
const QUERY = `
query JurisdictionPage($slug: ID!, $offset: Int!, $size: Int!) {
  formPageJurisdiction(id: $slug, idType: SLUG) {
    name
    seo {
      title
      metaDesc
      opengraphTitle
      opengraphDescription
      opengraphImage {
        sourceUrl
      }
    }
  }
  formFileCategoriesByJurisdiction(jurisdiction: $slug) {
    name
    slug
    count
  }
  formFiles(where: { offsetPagination: { offset: $offset, size: $size }, formPageJurisdiction: [$slug] }) {
    nodes {
      title
      slug
      featuredImage {
        node {
          sourceUrl
        }
      }
      formPageCategories {
        nodes {
          name
          slug
        }
      }
      formFileData {
        formPageLinkage(first: 1) {
          nodes {
            ... on FormPage {
              slug
              formPageData {
                shortName
                shortDescription
              }
            }
          }
        }
      }
    }
    pageInfo {
      offsetPagination {
        total
      }
    }
  }
}
`;

type JurisdictionPageResponse = {
  formPageJurisdiction: {
    name: string;
    seo: {
      title: string | null;
      metaDesc: string | null;
      opengraphTitle: string | null;
      opengraphDescription: string | null;
      opengraphImage: {
        sourceUrl: string;
      } | null;
    } | null;
  } | null;
  formFileCategoriesByJurisdiction: Array<{
    name: string;
    slug: string;
    count: number | null;
  }>;
  formFiles: {
    nodes: Array<{
      title: string | null;
      slug: string;
      featuredImage: {
        node: {
          sourceUrl: string;
        };
      } | null;
      formPageCategories: {
        nodes: Array<{
          name: string;
          slug: string;
        }>;
      };
      formFileData: {
        formPageLinkage: {
          nodes: Array<{
            slug: string;
            formPageData: {
              shortName: string | null;
              shortDescription: string | null;
            } | null;
          }>;
        } | null;
      } | null;
    }>;
    pageInfo: {
      offsetPagination: {
        total: number | null;
      } | null;
    };
  };
};

// Get jurisdiction slug from URL
const { jurisdiction } = Astro.params;

if (!jurisdiction) {
  return Astro.redirect("/forms");
}

const offset = Math.max(currentPage - 1, 0) * perPage;

// Fetch data
const data = await graphqlRequest<JurisdictionPageResponse>(QUERY, {
  slug: jurisdiction,
  offset,
  size: perPage,
});

if (!data.formPageJurisdiction) {
  return Astro.redirect("/forms");
}

const jurisdictionData = data.formPageJurisdiction;

const formFiles = data.formFiles.nodes;
const totalItems =
  data.formFiles.pageInfo.offsetPagination?.total ?? data.formFiles.nodes.length;
const totalPages = totalItems > 0 ? Math.ceil(totalItems / perPage) : 1;
const pageNumber = Math.min(Math.max(currentPage, 1), totalPages);

if (totalPages > 0 && currentPage > totalPages) {
  return Astro.redirect(`/forms/${jurisdiction}?page=${totalPages}`);
}

const categoriesWithCounts = data.formFileCategoriesByJurisdiction.filter(
  (category) => category.count && category.count > 0,
);

const breadcrumbs = [
  { label: "Home", to: "/" },
  { label: "Forms", to: "/forms" },
  { label: jurisdictionData.name },
];

const seo = jurisdictionData.seo;
const pageTitle = seo?.title || `${jurisdictionData.name} Forms`;
const pageDescription =
  seo?.metaDesc || `Browse form pages for ${jurisdictionData.name}.`;
const ogTitle = seo?.opengraphTitle ?? undefined;
const ogDescription = seo?.opengraphDescription ?? undefined;
const ogImage = seo?.opengraphImage?.sourceUrl;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  ogTitle={ogTitle}
  ogDescription={ogDescription}
  ogImage={ogImage}
>
  <Breadcrumbs items={breadcrumbs} />

  <section class="section-card">
    <h1 class="section-title">{jurisdictionData.name} Forms</h1>
    <p class="muted">Browse by category.</p>
    <ul class="list">
      {
        categoriesWithCounts.map((category) => (
          <li class="list-item">
            <a href={`/forms/${jurisdiction}/${category.slug}`}>
              {category.name}
            </a>
            <span class="pill">{category.count ?? 0} forms</span>
          </li>
        ))
      }
    </ul>
  </section>

  {
    (() => {
      return (
        formFiles.length > 0 && (
          <section class="section-card">
            <h2 class="section-title">All PDFs in {jurisdictionData.name}</h2>
            <p class="muted">
              {formFiles.length} PDF{formFiles.length !== 1 ? "s" : ""} on this
              page
              {totalPages > 1 && ` Â· Page ${pageNumber} of ${totalPages}`}
            </p>
            <div class="grid form-grid">
              {formFiles.map((file) => {
                const linkedPage =
                  file.formFileData?.formPageLinkage?.nodes?.[0];
                const category = file.formPageCategories.nodes[0];
                const categorySlug = category?.slug || "uncategorized";
                const categoryLabel = category?.name || "Uncategorized";
                const shortName =
                  linkedPage?.formPageData?.shortName ||
                  linkedPage?.slug ||
                  file.slug;
                const title =
                  file.title ||
                  linkedPage?.formPageData?.shortName ||
                  linkedPage?.slug ||
                  file.slug;
                const description = linkedPage?.formPageData?.shortDescription;
                const thumbnail =
                  file.featuredImage?.node?.sourceUrl || "/favicon.svg";

                const formUrl = `/forms/${jurisdiction}/${categorySlug}/${shortName}?file=${encodeURIComponent(file.slug)}`;

                return (
                  <a href={formUrl} class="form-card">
                    <div class="form-card-image">
                      <img src={thumbnail} alt={title} loading="lazy" />
                    </div>
                    <div class="form-card-content">
                      <h3>{title}</h3>
                      {description && (
                        <p class="muted">
                          {description.substring(0, 100)}
                          {description.length > 100 ? "..." : ""}
                        </p>
                      )}
                      <span class="pill" style="margin-top: 8px;">
                        {categoryLabel}
                      </span>
                    </div>
                  </a>
                );
              })}
            </div>

            <Pagination
              currentPage={pageNumber}
              totalPages={totalPages}
              baseUrl={`/forms/${jurisdiction}`}
            />
          </section>
        )
      );
    })()
  }

  <QueryBox
    query={QUERY}
    variables={{
      slug: jurisdiction,
      offset,
      size: perPage,
    }}
  />
</Layout>
