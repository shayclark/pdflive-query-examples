---
// Forms directory - all jurisdictions
import Layout from "../../layouts/Layout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import QueryBox from "../../components/QueryBox.astro";
import Pagination from "../../components/Pagination.astro";
import { graphqlRequest } from "../../lib/wpGraphql";

// Get page number from URL
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get("page") || "1", 10);
const perPage = 20;

// GraphQL query for jurisdictions and all forms
const QUERY = `
query FormFilesPage($offset: Int!, $size: Int!) {
  formPageJurisdictions(first: 200) {
    nodes {
      name
      slug
      count
    }
  }
  formFiles(where: { offsetPagination: { offset: $offset, size: $size } }) {
    nodes {
      title
      slug
      featuredImage {
        node {
          sourceUrl
        }
      }
      formPageJurisdictions {
        nodes {
          name
          slug
        }
      }
      formPageCategories {
        nodes {
          name
          slug
        }
      }
      formFileData {
        formPageLinkage(first: 1) {
          nodes {
            ... on FormPage {
              slug
              formPageData {
                shortName
                shortDescription
              }
            }
          }
        }
      }
    }
    pageInfo {
      offsetPagination {
        total
      }
    }
  }
}
`;

// Fetch jurisdictions data
type FormFilesResponse = {
  formPageJurisdictions: {
    nodes: Array<{
      name: string;
      slug: string;
      count: number | null;
    }>;
  };
  formFiles: {
    nodes: Array<{
      title: string | null;
      slug: string;
      featuredImage: {
        node: {
          sourceUrl: string;
        };
      } | null;
      formPageJurisdictions: {
        nodes: Array<{
          name: string;
          slug: string;
        }>;
      };
      formPageCategories: {
        nodes: Array<{
          name: string;
          slug: string;
        }>;
      };
      formFileData: {
        formPageLinkage: {
          nodes: Array<{
            slug: string;
            formPageData: {
              shortName: string | null;
              shortDescription: string | null;
            } | null;
          }>;
        } | null;
      } | null;
    }>;
    pageInfo: {
      offsetPagination: {
        total: number | null;
      } | null;
    };
  };
};

const offset = Math.max(currentPage - 1, 0) * perPage;
const data = await graphqlRequest<FormFilesResponse>(QUERY, {
  offset,
  size: perPage,
});
const jurisdictions = data.formPageJurisdictions.nodes;
const formFiles = data.formFiles.nodes;
const totalItems =
  data.formFiles.pageInfo.offsetPagination?.total ?? data.formFiles.nodes.length;
const totalPages = totalItems > 0 ? Math.ceil(totalItems / perPage) : 1;
const pageNumber = Math.min(Math.max(currentPage, 1), totalPages);

if (totalPages > 0 && currentPage > totalPages) {
  return Astro.redirect(`/forms?page=${totalPages}`);
}

// Filter out jurisdictions with null count or 0 count for cleaner display
const activeJurisdictions = jurisdictions.filter((j) => j.count && j.count > 0);

const breadcrumbs = [{ label: "Home", to: "/" }, { label: "Forms" }];
---

<Layout
  title="Forms Directory"
  description="Browse PDF.live form pages by jurisdiction."
>
  <Breadcrumbs items={breadcrumbs} />

  <section class="section-card">
    <h1 class="section-title">Forms Directory</h1>
    <p class="muted">Browse by jurisdiction (location).</p>
    <ul class="list">
      {
        activeJurisdictions.map((jurisdiction) => (
          <li class="list-item">
            <a href={`/forms/${jurisdiction.slug}`}>{jurisdiction.name}</a>
            <span class="pill">{jurisdiction.count ?? 0} forms</span>
          </li>
        ))
      }
    </ul>
  </section>

  {
    (() => {
      return (
        formFiles.length > 0 && (
          <section class="section-card">
            <h2 class="section-title">All PDFs</h2>
            <p class="muted">
              {formFiles.length} PDF{formFiles.length !== 1 ? "s" : ""} on this
              page
              {totalPages > 1 && ` ¬∑ Page ${pageNumber} of ${totalPages}`}
            </p>
            <div class="grid form-grid">
              {formFiles.map((file) => {
                const linkedPage =
                  file.formFileData?.formPageLinkage?.nodes?.[0];
                const jurisdiction = file.formPageJurisdictions.nodes[0];
                const category = file.formPageCategories.nodes[0];
                const jurisdictionSlug = jurisdiction?.slug || "uncategorized";
                const categorySlug = category?.slug || "uncategorized";
                const jurisdictionLabel = jurisdiction?.name || "Uncategorized";
                const categoryLabel = category?.name || "Uncategorized";
                const shortName =
                  linkedPage?.formPageData?.shortName ||
                  linkedPage?.slug ||
                  file.slug;
                const title =
                  file.title ||
                  linkedPage?.formPageData?.shortName ||
                  linkedPage?.slug ||
                  file.slug;
                const description = linkedPage?.formPageData?.shortDescription;
                const thumbnail =
                  file.featuredImage?.node?.sourceUrl || "/favicon.svg";

                const formUrl = `/forms/${jurisdictionSlug}/${categorySlug}/${shortName}?file=${encodeURIComponent(file.slug)}`;

                return (
                  <a href={formUrl} class="form-card">
                    <div class="form-card-image">
                      <img src={thumbnail} alt={title} loading="lazy" />
                    </div>
                    <div class="form-card-content">
                      <h3>{title}</h3>
                      {description && (
                        <p class="muted">
                          {description.substring(0, 100)}
                          {description.length > 100 ? "..." : ""}
                        </p>
                      )}
                      <div style="display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap;">
                        <span class="pill">üìç {jurisdictionLabel}</span>
                        <span class="pill">üìÇ {categoryLabel}</span>
                      </div>
                    </div>
                  </a>
                );
              })}
            </div>

            {totalPages > 1 && (
              <Pagination
                currentPage={pageNumber}
                totalPages={totalPages}
                baseUrl="/forms"
              />
            )}
          </section>
        )
      );
    })()
  }

  <QueryBox
    query={QUERY}
    variables={{ offset, size: perPage }}
  />
</Layout>
